resources:
- name: pcf-pipelines
  type: git
  source:
    uri: https://github.com/c0-ops/pcf-pipelines.git
    branch: master

jobs:
- name: test
  plan:
  - get: pcf-pipelines
    trigger: true
  - task: test
    file: pcf-pipelines/ci/tasks/test.yml

- name: update-upgrade-ert
  plan:
  - get: pcf-pipelines
    trigger: true
    passed:
    - test
  - task: update-pipeline
    file: pcf-pipelines/ci/tasks/update_pipeline.yml
    params:
      PIPELINE_NAME: upgrade-ert
      PIPELINE_PATH: pcf-pipelines/upgrade-ert/pipeline.yml
      ATC_EXTERNAL_URL: {{atc_external_url}}
      ATC_BASIC_AUTH_USERNAME: {{fly_basic_auth_username}}
      ATC_BASIC_AUTH_PASSWORD: {{fly_basic_auth_password}}

      PIVNET_TOKEN: {{pivnet_token}}
      OPSMAN_ADMIN_USERNAME: {{opsman_admin_username}}
      OPSMAN_ADMIN_PASSWORD: {{opsman_admin_password}}
      OPSMAN_URI: {{opsman_uri}}
      GITHUB_TOKEN: {{github_token}}
      IAAS_TYPE: {{iaas_type}}
      PIVNET_POLL_INTERVAL: {{pivnet_poll_interval}}
      OPSMAN_TIMEOUT_SECONDS: {{opsman_timeout_seconds}}

- name: update-upgrade-buildpacks
  plan:
  - get: pcf-pipelines
    trigger: true
    passed:
    - test
  - task: update-pipeline
    file: pcf-pipelines/ci/tasks/update_pipeline.yml
    params:
      PIPELINE_NAME: upgrade-buildpacks
      PIPELINE_PATH: pcf-pipelines/upgrade-buildpacks/pipeline.yml
      ATC_EXTERNAL_URL: {{atc_external_url}}
      ATC_BASIC_AUTH_USERNAME: {{fly_basic_auth_username}}
      ATC_BASIC_AUTH_PASSWORD: {{fly_basic_auth_password}}

      PIVNET_TOKEN: {{pivnet_token}}
      PIVNET_POLL_INTERVAL: {{pivnet_poll_interval}}
      CF_API_URI: {{cf_api_uri}}
      CF_USER: {{cf_user}}
      CF_PASSWORD: {{cf_password}}
